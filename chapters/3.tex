\chapter{Corelations: a tool for black boxing} \label{ch.corelations}

Black boxing!

USE MATERIAL FROM INTRODUCTION OF CORELATIONS PAPER AND CORELATIONS
SECTION IN BLACK BOX PAPER
\section{The idea of black boxing}

Consider a circuit diagram.
\[
  \begin{tikzpicture}
    \draw (0,0) -- (0,4.5) -- (8,4.5) -- (8,0) -- (0,0);
  \end{tikzpicture}
\]
We often view such diagrams atomically, representing the complete physical
system built as specified. Yet the very process of building such a system
involves assembling it from its parts, each of which we might diagram in the
same way. The goal of this paper is to develop formal category-theoretic tools
for describing and interpreting this process of assembly.

Circuits are constructed to get at some behaviour, with two circuits equivalent
if they specify the same behaviour. Here we focus on this `black boxing' aspect.


Corelations \cite{CF}.

Semantics live on boundaries only.

We then introduce a new framework for working with hypergraph
categories: decorated corelations.

Decorated corelations adds compositional operations to network-diagram
representations, and handles composition of semantics too. 

Two main theorems: 
\begin{theorem}
Given a category $\mc C$ with finite colimits, factorisation system $(\mc E,\mc
M)$ such that $\mc M$ is stable under pushouts, and a symmetric lax monoidal functor 
\[
  \mc C; \mc M^\opp \longrightarrow \Set,
\]
we may define a hypergraph category of with morphisms decorated corelations.
\end{theorem}

\begin{theorem}
Every hypergraph category can be constructed in this way.
\end{theorem}

They apply to functors too.



\section{Corelations}

Given sets $X$, $Y$, a relation $X \leadsto Y$ is a subset of the product $X
\times Y$. More abstractly, we might say a relation is a jointly-monic span in
the category of sets (or an isomorphism class thereof). We generalise the dual
concept.

\subsection{Factorisation systems.}
The relevant properties of jointly-monic spans come from the fact that
monomorphisms form one half of a factorisation system. A factorisation system
allows any morphism in a category to be factored into the composite of two
morphisms in a coherent way.

\begin{definition}
  A \define{factorisation system} $(\mathcal E,\mathcal M)$ in a category
  $\mathcal C$ comprises subcategories $\mathcal E$, $\mathcal M$ of $\mathcal
  C$ such that
  \begin{enumerate}[(i)]
    \item $\mathcal E$ and $\mathcal M$ contain all isomorphisms of $\mathcal
      C$.
    \item  every morphism $f \in \mathcal C$ admits a factorisation $f=m \circ
      e$, $e \in \mathcal E$, $m \in \mathcal M$.
\item given morphisms $f,f'$, with factorisations $f = m \circ e$, $f' = m' \circ
  e'$ of the above sort, for every $u$, $v$ such that the square
  \[
    \xymatrixcolsep{3pc}
    \xymatrixrowsep{3pc}
    \xymatrix{
       \ar[r]^f \ar[d]_u &  \ar[d]^v \\
       \ar[r]_{f'} & 
    }
  \]
  commutes, there exists a unique morphism $s$ such that
  \[
    \xymatrixcolsep{3pc}
    \xymatrixrowsep{3pc}
    \xymatrix{
      \ar[r]^e \ar[d]_u & \ar[r]^m \ar@{.>}[d]^{\exists! s} &  \ar[d]^v \\
       \ar[r]_{e'}& \ar[r]_{m'} & 
    }
  \]
  commutes.
  \end{enumerate}
\end{definition}

\begin{examples}
  We introduce some factorisation systems of central importance in what follows.
  \begin{itemize}
    \item Write $\mathcal I_{\mathcal C}$ for the wide subcategory of
      $\mathcal C$ containing exactly the isomorphisms of $\mathcal C$. Then
      $(\mathcal I_{\mathcal C}, \mathcal C)$ and $(\mathcal C, \mathcal
      I_{\mathcal C})$ are both factorisation systems in $\mathcal C$. 
    
    \item The prototypical example of a factorisation system is the epi-mono
      factorisation system in $\Set$. This follows from a more general fact,
      true in any category, that if every arrow can be factorised as an epi
      followed by a split mono, then this results in a factorisation system.
      The only non-trivial part to check is the uniqueness condition: given epis
      $e_1,e_2$, split monos $m_1,m_2$, and commutative diagram
      \[
	\xymatrixcolsep{3pc}
	\xymatrixrowsep{3pc}
	\xymatrix{
	  \ar[r]^{e_1} \ar[d]_u & \ar[r]^{m_1} \ar@{.>}[d]^{\exists! t} &  \ar[d]^v \\
	  \ar[r]_{e_2}& \ar[r]_{m_2} & 
	}
      \]
      we must show that there is a unique $t$ that makes the diagram commute.
      Indeed let $t= m_2'vm_1$ where $m_2'$ satisfies $m_2'm_2=id$. 
      To see that the right square commutes, observe
      \[
	m_2 t e_1 =  m_2 m_2' v m_1 e_1 = m_2 m_2' m_2 e_2 u = m_2 e_2 u = v m_1 e_1
      \]
      and since $e_1$ is epi we have $m_2 t = v m_1$. For the left square,
      \[
	t e_1 = m_2' v m_1 e_1 = m_2' m_2 e_2 u = e_2 u.
      \] 
      Uniqueness is immediate, since, $e_1$ is epi and $m_2$ is mono. 
\end{itemize}
\end{examples}

See \cite[\textsection 14]{AHS} for more details.

\begin{definition}
Call a factorisation system $(\mc E,\mc M)$ in a monoidal category $(\mc C,\ot)$
a \define{monoidal factorisation system} if $(\mc E,\ot)$ is a monoidal
category.
\end{definition}

One might wonder why $\mc M$ does not appear in the above definition. To give a
touch more intuition for this definition, we quote a theorem of Ambler. Recall a
symmetric monoidal closed category is one in which each functor $- \ot X$ has a
specified right adjoint $[X,-]$. See Ambler for proof and further details
\cite[Lemma 5.2.2]{Am}.
\begin{proposition}
  Let $(\mc E,\mc M)$ be a factorisation system in a symmetric monoidal
  closed category $(\mc C,\ot)$. Then the following are equivalent:
  \begin{enumerate}[(i)]
    \item $(\mc E,\mc M)$ is a monoidal factorisation system.
    \item $\mc E$ is closed under $- \ot X$ for all $X \in \mc C$.
    \item $\mc M$ is closed under $[X,-]$ for all $X \in \mc C$.
\end{enumerate}
\end{proposition}

In a category with finite coproducts every factorisation system is a monoidal
factorisation system for the coproduct.
\begin{lemma} \label{lem.monfact}
  Let $\mc C$ be a category with finite coproducts, and let $(\mc E, \mc M)$ be a
  factorisation system on $\mc C$. Then $(\mc E,+)$ is a symmetric monoidal
  category.
\end{lemma}
\begin{proof}
  The only thing to check is that $\mc E$ is closed under $+$. That is, given
  $f\maps A \to B$ and $g\maps C \to D$ in $\mc E$, we wish to show that
  $f+g\maps A+C \to B+D$, defined in $\mc C$, is also a morphism in $\mc E$. 

  Let $f+g$ have factorisation $A+C \stackrel{e}\longrightarrow \overline{B+D}
  \stackrel{m}\longrightarrow B+D$, where $e \in \mc E$ and $m \in \mc
  M$. We will prove that $m$ is an isomorphism. To construct an inverse, recall
  that by definition, as $f$ and $g$ lie in $\mc E$, there exist morphisms
  $x\maps B \to \overline{B+D}$ and $y\maps D \to \overline{B+D}$ such that
  \[ \label{eq.coreltensor}
    \xymatrixcolsep{2pc}
    \xymatrixrowsep{2pc}
    \xymatrix{
      A \ar[r]^f \ar[d] & B \ar@{=}[r] \ar@{.>}[d]^x & B
      \ar[d] \\
      A+C \ar[r]_{e}&\overline{B+D} \ar[r]_{m} & B+D
    }
    \qquad \mbox{and} \qquad
    \xymatrixcolsep{2pc}
    \xymatrixrowsep{2pc}
    \xymatrix{
      C \ar[r]^g \ar[d] & D \ar@{=}[r] \ar@{.>}[d]^y & D
      \ar[d] \\
      A+C \ar[r]_{e}&\overline{B+D} \ar[r]_{m} & B+D
    }
    \tag{1}
  \]
  The copairing $[x,y]$ is an inverse to $m$. 
  
  Indeed, taking the coproduct of the top rows of the two diagrams above and the
  copairings of the vertical maps gives the commutative diagram
  \[
    \xymatrix{
      A+C \ar[r]^{f+g} \ar@{=}[d] & B+D \ar@{=}[r] \ar[d]_{[x,y]} & B+D \ar@{=}[d] \\
      A+C \ar[r]^{e} & \overline{B+D} \ar[r]^{m} & B+D
    }
  \]
  Reading the right-hand square immediately gives $m \circ [x,y] =1$.
  
  Conversely, to see that $[x,y] \circ m = 1$, remember that by definition $f+g
  = m \circ e$. So the left-hand square above implies that
  \[
    \xymatrixcolsep{2pc}
    \xymatrixrowsep{2pc}
    \xymatrix{
      A+C \ar[r]^e \ar@{=}[d] & \overline{B+D} \ar[d]^{[x,y] \circ m} \\
      A+C \ar[r]_{e}&\overline{B+D} 
    }
  \]
  commutes. But by the universal property of factorisation systems, there is a
  unique map $\overline{B+D} \to \overline{B+D}$ such that this diagram
  commutes, and clearly the identity map also suffices. Thus $[x,y] \circ m =
  1$.
\end{proof}

\subsection{Corelations}
Relations, then, may be generalised as spans such that the span maps `jointly'
belong to some class $\mc M$ of an $(\mc E,\mc M)$-factorisation system. We
define corelations in the dual manner.

\begin{definition}
  Let $\mathcal C$ be a category with finite colimits, and let $(\mathcal E,
  \mathcal M)$ be a factorisation system on $\mathcal C$. An \define{$(\mathcal
  E,\mathcal M)$-corelation} $X \leadsto Y$ is a cospan $X
  \stackrel{i}\longrightarrow N \stackrel{o}\longleftarrow Y$ such that the
  copairing $[i,o]\maps X+Y \to N$ lies in $\mathcal E$.
\end{definition}

When the factorisation system is clear from context, we simply call $(\mathcal
E,\mathcal M)$-corelations: `corelations'.

We also say that a cospan $X \stackrel{i}\longrightarrow N
\stackrel{o}\longleftarrow Y$ with the property that the copairing $[i,o]\maps X+Y \to N$ lies in $\mathcal E$ is \define{jointly $\mathcal E$-like}. Note that
if a cospan is jointly $\mc E$-like then so are all isomorphic cospans. Thus the
property of being a corelation is closed under isomorphism of cospans, and we
again are often lazy with out language, referring to both jointly $\mc E$-like
cospans and their isomorphism classes as corelations. 

If $f\maps A \to N$ is a morphism with factorisation $f = m \circ e$, write
$\overline N$ for the object such that $e\maps A \to \overline N$ and $m\maps
\overline N \to N$. Now, given a cospan $X \stackrel{i_X}{\longrightarrow} N
\stackrel{o_Y}{\longleftarrow} Y$, we may use the factorisation system to write
the copairing $[i_X,o_Y]\maps X+Y \to N$ as
\[
  X+Y \stackrel{e}{\longrightarrow} \overline{N} \stackrel{m}{\longrightarrow}
  N.
\]
From the universal property of the coproduct, we also have maps $\iota_X\maps X
\to X+Y$ and $\iota_Y\maps Y \to X+Y$. We then call the corelation 
\[
  X \stackrel{e\circ \iota_X}{\longrightarrow} \overline{N} \stackrel{e \circ
  \iota_Y}{\longleftarrow} Y
\]
the \define{$\mathcal E$-part} of the above cospan. On occasion we will also
write $e\maps X+Y \to \overline N$ for the same corelation.

\begin{examples} \label{ex.corels}
  Many examples of corelations are already familiar.
  \begin{itemize}
    \item For the morphism-isomorphism factorisation system $(\mc C,\mc I_{\mc
      C})$, corelations are just cospans.
    \item For the isomorphism-morphism factorisation $(\mc I_{\mc C}, \mc C)$,
      jointly $\mc I_{\mc C}$-like cospans $X \to Y$ are simply isomorphisms
      $X+Y \stackrel\sim\to N$. Thus there is a unique isomorphism class of
      corelation between any two objects.
    \item Note that the category $\Set$ has finite colimits and an epi-mono
      factorisation system. Epi-mono corelations from $X \to Y$ in $\mathrm{Set}$
      surjective functions $X+Y \to N$; thus their isomorphism classes are
      partitions, or equivalence relations on $X+Y$. 
  \end{itemize}
\end{examples}

\subsection{Categories of corelations}

We compose corelations by taking the $\mathcal E$-part of their composite
cospan. That is, given corelations $X \stackrel{i_X}{\longrightarrow} N
\stackrel{o_Y}{\longleftarrow} Y$ and $Y \stackrel{i_Y}{\longrightarrow} M
\stackrel{o_Z}{\longleftarrow} Z$, their composite is given by the cospan $X
\to \overline{N+_YM} \leftarrow Z$ in
\[
  \xymatrix{
    && N+_YM \\
    && \overline{N+_YM} \ar[u]_{m} \\
    & N \ar[ur]^{e \circ \iota_N} && M \ar[ul]_{e \circ \iota_M} \\
    \quad X \quad \ar[ur]^{i_X} && Y \ar[ul]_{o_Y} \ar[ur]^{i_Y} && \quad Z, \quad \ar[ul]_{o_Z}
  }
\]
where $m \circ e$ is the $(\mc E,\mc M)$-factorisation of $[j_N,j_M]\maps N+M
\to N+_YM$. 

It is well-known that this composite is unique up to isomorphism, and that when
$\mc M$ is well-behaved it defines a category with morphisms isomorphism classes
of corelations. For example, bicategorical version of the dual theorem, for
spans and relations, can be found in \cite{JW}. Nonetheless, for the sake of
completeness we sketch our own argument here.

\begin{proposition} \label{prop.corelcomp}
  Let $\mc C$ be a category with finite colimits and with a factorisation system
  $(\mc E,\mc M)$. Then the above is a well-defined composition rule on
  isomorphism classes of corelations.
\end{proposition}
\begin{proof}
  Let
  $(X \stackrel{i_X}{\longrightarrow} N \stackrel{o_Y}{\longleftarrow} Y$,
  $X \stackrel{i_X'}{\longrightarrow} N' \stackrel{o_Y'}{\longleftarrow} Y)$
%  \[
%    X \stackrel{i_X}{\longrightarrow} N \stackrel{o_Y}{\longleftarrow} Y 
%    \qquad \mbox{and} \qquad 
%    X \stackrel{i_X'}{\longrightarrow} N' \stackrel{o_Y'}{\longleftarrow} Y
%  \]
  and
  $(Y \stackrel{i_Y}{\longrightarrow} M \stackrel{o_Z}{\longleftarrow} Z$, $Y
  \stackrel{i_Y'}{\longrightarrow} M' \stackrel{o_Z'}{\longleftarrow} Z)$
%  \[
%    Y \stackrel{i_Y}{\longrightarrow} M \stackrel{o_Z}{\longleftarrow} Z 
%    \qquad \mbox{and} \qquad 
%    Y \stackrel{i_Y'}{\longrightarrow} M' \stackrel{o_Z'}{\longleftarrow} Z
%  \]
  be pairs of isomorphic jointly $\mathcal E$-like cospans. Their composites
  \emph{as cospans} 
  % $(X \longrightarrow N+_YM \longleftarrow Z)$ and $(X
  %\longrightarrow N'+_YM' \longleftarrow Z)$
%  \[
%    X \longrightarrow N+_YM \longleftarrow Z 
%    \qquad \mbox{and} \qquad 
%    X \longrightarrow N'+_YM' \longleftarrow Z
%  \]
  are isomorphic, so the factorisation system gives an isomorphism $s$ such that
  the diagram
  \[
    \xymatrixcolsep{3pc}
    \xymatrixrowsep{2pc}
    \xymatrix{
      X+Z \ar[r]^e \ar@{=}[d] & \overline{N+_YM} \ar[r]^m \ar@{.>}[d]^{s}_\sim & N+_YM
      \ar[d]^\sim \\
      X+Z \ar[r]_{e'}&\overline{N'+_YM'} \ar[r]_{m'} & N'+_YM'
    }
  \]
  commutes. This $s$ is an isomorphism of the composite corelations.
\end{proof}

Composition of corelations is \emph{not} associative in general. It is, however,
associative when $\mathcal M$ is \define{stable under pushout}: that is,
whenever
\[
  \xymatrixcolsep{3pc}
  \xymatrixrowsep{3pc}
  \xymatrix{
    \ar[r]^j & \\
    \ar[u] \ar[r]^m &  \ar[u]
  }
\]
is a pushout square such that $m \in \mathcal M$, we also have that $j \in
\mathcal M$. 

Stability under pushout is a powerful property. A key corollary, both for
associativity and in general, is that it implies $\mc M$ is also closed under
$+$. 
%For our proof sketch we rely on the following useful lemma.

\begin{lemma} \label{lem.mcoproductsmc}
  Let $\mathcal C$ be a category with finite colimits, and let $\mathcal M$ be a
  subcategory of $\mathcal C$ stable under pushouts and containing all
  isomorphisms. Then $(\mc M,+)$ is a symmetric monoidal category.
\end{lemma}
\begin{proof}
  It is enough to show that for all morphisms $m,m' \in \mc M$ we have $m+m'$ in
  $\mc M$. Since $\mc M$ contains all isomorphisms, the coherence maps are
  inherited from $\mc C$. The required axioms---the functoriality of the tensor
  product, the naturality of the coherence maps, and the coherence laws---are
  also inherited as they hold in $\mc C$.

  To see $m+m'$ is in $\mc M$, simply observe that we have the pushout square
  \[
  \xymatrixcolsep{3pc}
  \xymatrixrowsep{2pc}
    \xymatrix{
      A+C \ar[r]^{m+1} & B+C \\
      A \ar[r]^m \ar[u]^{\iota} & B \ar[u]_{\iota} \\
    }
  \]
  in $\mc C$. As $\mc M$ is stable under pushout, $m+1 \in \mc M$. Similarly,
  $1+m' \in \mc M$. Thus their composite $m+m'$ lies in $\mc M$, as required.
\end{proof}

An analogous argument shows that pushouts of maps $m+_Ym'$ also lie in $\mc M$.
Using this lemma it is not difficult to show associativity---the key point is
that factorisation `commutes' with pushouts, and that we have a category
$\corel_{(\mc E,\mc M)}(\mc C)$. Again, this is all well-known, and can be found
in \cite{JayWar00}. We will incidentally reprove these facts in the following,
while pursuing richer structure.

%\begin{proposition}
%  Let $\mc C$ be a category with finite colimits and a factorisation system
%  $(\mc E,\mc M)$ such that $\mc M$ is stable under pushouts. Then composition
%  of corelations is associative.
%\end{proposition}
%\begin{proof}[Proof (sketch)]
%  The key concern is whether factorisation `commutes' with taking pushouts.
%  Using the above lemma and the fact that $\mc M$ is stable under pushouts, the
%  pushout square 
%  \[
%  \xymatrixcolsep{3pc}
%  \xymatrixrowsep{2pc}
%  \xymatrix{
%    N+_Y\overline{M} \ar[r]^{m'} & N+_YM \\
%    N+\overline{M} \ar[u] \ar[r]^{1+m} & N+M  \ar[u]
%  }
%  \]
%  shows that the map $m'\maps N+_Y\overline{M} \to N+_YM$ is in $\mc M$
%  whenever $m\maps \overline{N} \to N$ is. It can then be shown that the
%  composite of any number of corelations can be given by taking the composite of
%  them all as cospans, and then taking the jointly $\mc E$-like part.
%\end{proof}

%The identity axioms for corelations are self-evident. We thus have a category
%$\corel_{(\mc E,\mc M)}(\mc C)$.  Again, we will drop explicit reference to the
%factorisation system when context allows, simply writing $\mathrm{Corel}(\mc
%C)$.
%
%\begin{remark}
%An aside: proving associativity is not logically necessary in the development
%of this chapter. Associativity will follow from the existence of the functor
%from $\cospan(\mc C)$ to $\corel(\mc C)$, like the other necessary coherence
%results for hypergraph categories. Nonetheless, it is terminologically easier to
%establish that $\corel(\mc C)$ is indeed a category at this point, before we
%define hypergraph structure and functors on it.
%\end{remark}
%

Indeed, for modelling networks, we require not just a category, but a hypergraph
category. Corelation categories come equipped with this extra structure.
Recall that we gave decorated cospan categories a hypergraph structure by
defining a wide embedding $\mathrm{Cospan}(\mc C) \hookrightarrow
F\mathrm{Cospan}$, via which $F\mathrm{Cospan}$ inherited the coherence and
Frobenius maps (Theorem \ref{thm:fcospans}). We will argue similarly here, after
showing that the `quotient' map
\[
  \cospan(\mc C) \longrightarrow \corel(\mc C)
\]
taking each cospan to its jointly $\mc E$-like part is functorial. Indeed, we
define the coherence and Frobenius maps of $\corel(\mc C)$ to be their image
under this map. For the monoidal product we again use the coproduct in $\mc C$.

\begin{theorem} \label{thm.cospantocorel}
  Let $\mathcal C$ be a category with finite colimits, and let $(\mathcal E,
  \mathcal M)$ be factorisation system on $\mathcal C$ such that $\mathcal M$ is
  stable under pushout. Then there exists a hypergraph category
  $\mathrm{Corel}_{(\mc E,\mc M)}(\mathcal C)$ with 
  \begin{center}
    \begin{tabular}{| c | p{.65\textwidth} |}
      \hline
      \multicolumn{2}{|c|}{The hypergraph category $(\mathrm{Corel}_{(\mc E,\mc M)}(\mc C),+)$} \\
      \hline
      \textbf{objects} & the objects of $\mathcal C$ \\ 
      \textbf{morphisms} & isomorphism classes of $(\mc E,\mc M)$-corelations in $\mathcal C$\\ 
      \textbf{composition} & given by the $\mc E$-part of pushout \\
      \textbf{monoidal product} & the coproduct in $\mathcal C$ \\
      \textbf{coherence maps} & inherited from $\cospan(\mc C)$  \\
      \textbf{hypergraph maps} & inherited from $\cospan(\mc C)$ \\
      \hline
    \end{tabular}
  \end{center}  
\end{theorem}

Again, we will drop explicit reference to the factorisation system when context allows, simply writing $\mathrm{Corel}(\mc C)$.

Proposition \ref{prop.corelcomp} shows that our composition rule is a
well-defined function, Lemma \ref{lem.monfact} shows likewise for the monoidal
product $+\maps \corel(\mc C)\times \corel(\mc C) \to \corel(\mc C)$. Thus we
have the required data for a hypergraph category. It just remains to check a
number of axioms: associativity and unitality of the categorical composition,
functoriality of the monoidal product, naturality of the coherence maps, the
coherence axioms for symmetric monoidal categories, the Frobenius laws.

Our strategy for this will simply be to show that the (surjective) function
taking a cospan to its jointly $\mc E$-part preserves composition and has
natural strict monoidal coherence maps. This implies that to evaluate an
expression in the monoidal category of corelations, we may simply evaluate it in
the monoidal category of cospans, and then take the $\mc E$-part. Thus if an
equation is true for cospans, it is true for corelations.

Instead of proving just this, however, we will prove a generalisation regarding
the analogous `reduction' map between any two corelation `categories'. This will
reduce to the desired special case by taking the domain to be the `trivial'
$(\mc C,\mc I_{\mc C})$-corelations, which we know is equal to the hypergraph
category of cospans. But the generality is not spurious: it has the advantage of
proving the existence of a class of hypergraph functors between corelation
categories in the same fell swoop.

Although a touch convoluted, this strategy is worth the pause for thought. We
will use it once again for \emph{decorated corelations}, to great economy.

%\begin{lemma}
%  The map $(-)+(-)\maps \corel(\mc C)\times\corel(\mc C) \to \corel(\mc C)$
%  induced by the coproduct in $\mc C$ is functorial.
%\end{lemma}
%\begin{proof}
%As a preliminary, note that $+$ is a well-defined function: Lemma
%\ref{lem.monfact} implies that the coproduct of two corelations is again a
%corelation. Our task is to show that, given the four corelations 
%\[
%  \xymatrixrowsep{0pt}
%  \xymatrix{
%  f= X \longrightarrow N \longleftarrow Y  & &
%  g= Y \longrightarrow M \longleftarrow Z \\
%  h = X' \longrightarrow N' \longleftarrow Y' & &
% k= Y' \longrightarrow M' \longleftarrow Z'
%}
%\]
%we have $(g \circ f) + (k \circ h) = (g + k) \circ (f + h)$. The left and
%right side of this expression are respectively given by the first arrow in the
%upper and lower rows of the commutative diagram
%\[
%  \xymatrix{
%    (X+Z)+(X'+Z') \ar[r]^{\mc E+\mc E} \ar[d]^{\sim} & 
%    (\overline{N+_YM})+(\overline{N'+_{Y'}M'}) \ar[r]^{\mc M+\mc M} \ar@{.}[d] &
%    (N+_YM)+(N'+_{Y'}M') \ar[d]^{\sim} \\
%    (X+X')+(Z+Z') \ar[r]^{\mc E} &
%    \overline{(N+N')+_{Y+Y'}(M+M')} \ar[r]^{\mc M} & 
%    (N+N')+_{Y+Y'}(M+M'). \\
%  }
%\]
%The leftmost and rightmost vertical arrows are isomorphisms by properties of
%colimits. The upper row is an $(\mc E,\mc M)$-factorisation as the first map is
%the coproduct of two maps in $\mc E$ and the second map is the coproduct of two
%maps in $\mc M$, both of which are monoidal with respect to the coproduct
%(Lemmas \ref{lem.monfact} and \ref{lem.mcoproductsmc}). The lower row is an
%$(\mc E,\mc M)$-factorisation by definition. Thus, by the properties of
%factorisation systems, the dotted map $s$ is an isomorphism, and hence $+$ is
%functorial. 
%\end{proof}
%
%To prove Theorem \ref{thm.cospantocorel} it remains to show that our proposed
%data for $\mathrm{Corel}(\mc C)$ obey the necessary axioms: the symmetric
%monoidal coherence laws, the special commutative Frobenius monoid laws. Our
%proof strategy will be a touch complicated. Again, recall that in Theorem
%\ref{thm:fcospans} we proved $F\mathrm{Cospan}$ had hypergraph structure via
%a functor from $\cospan(\mc C)$. Instead of proving each axiom directly, we will
%again leverage the fact that we already know $\cospan(\mc C)$ is a hypergraph
%category, and show that $\corel(\mc C)$ is the image of $\cospan(\mc C)$ under a
%composition-preserving map that also respects (indeed, defines) the monoidal and
%hypergraph structure.
%
%Note that $\mc C$ is trivially stable under pushout. By definition we have the
%equality of hypergraph categories $\mathrm{Corel}_{(\mc C,\mc I_{\mc C})}(\mc
%C)= \cospan(\mc C)$. Thus the functor $\cospan(\mc C) \to \mathrm{Corel}(\mc C)$
%is a special case of functors between corelation categories. Taking advantage of
%this, we will discuss functors between corelation categories in general, before
%specialising to this case to prove that $\mathrm{Corel}(\mc C)$ indeed is a
%well-defined hypergraph category.
%
%This will be done in the next subsection.



\subsection{Functors between corelation categories}
We have seen that to construct a functor between cospan categories one may start
with a colimit-preserving functor between the underlying categories. Corelation
categories are similar, but we remove the part of each cospan that lies in $\mc
M$. Hence for functors between corelation categories, we also require that the
target category removes at least as much information as the source category.

\begin{proposition} \label{prop.corelfunctors}
  Let $\mathcal C$, $\mathcal C'$ have finite colimits and respective
  factorisation systems $(\mathcal E, \mathcal M)$, $(\mathcal E', \mathcal M')$,
  such that $\mathcal M$ and $\mathcal M'$ are stable under pushout. Further let
  $A\maps \mathcal C \to \mathcal C'$ be a functor that preserves finite colimits
  and such that the image of $\mathcal M$ lies in $\mathcal M'$.

  Then we may define a hypergraph functor $\square\maps \corel(\mathcal C) \to
  \corel(\mathcal C')$ sending each object $X$ in $\corel(\mathcal C)$ to $AX$ in
  $\corel(\mc C')$ and each corelation 
  \[
    X \stackrel{i_X}{\longrightarrow} N \stackrel{o_Y}{\longleftarrow} Y 
  \]
  to the jointly-$\mc E'$-part
  \[
    AX \stackrel{Ai_X}{\longrightarrow} \overline{AN} \stackrel{Ao_Y}{\longleftarrow} AY.
  \]
  of the image cospan. The coherence maps are the isomorphisms
  $\kappa_{X,Y}\maps AX+AY \to A(X+Y)$ given as $A$ preserves colimits.
\end{proposition}

As discussed, we are still yet to prove that $\corel(\mc C)$ is a hypergraph
category. We address this first with two lemmas regarding these proposed
functors.

\begin{lemma}
  The above function $\square\maps \corel(\mc C) \to \corel(\mc C')$ preserves
  composition
\end{lemma}
\begin{proof}
  Let $f = (X \longrightarrow N \longleftarrow Y)$ and $g= (Y \longrightarrow M
  \longleftarrow Z)$ be corelations in $\mathcal C$. By definition, the
  corelations $\square(g) \circ \square(f)$ and $\square(g \circ f)$ are given
  by the first arrows in the top and bottom row respectively of the diagram:
  \[ %\label{diag.eparts}
    \begin{aligned}
      \xymatrixcolsep{4pc}
      \xymatrixrowsep{2pc}
      \xymatrix{
	AX+AZ \ar[r]^{\mc E'} \ar@{=}[d] & \overline{\overline{AN}+_{AY}\overline{AM}}
	\ar[r]^{\mc M'} \ar@{<.>}[d]^{n} & \overline{AN}+_{AY}\overline{AM}
	\ar[r]^{m'_{AN}+_{AY}m'_{AM}} &
	AN+_{AY}AM \\
	AX+AZ \ar[r]^{\mc E'} & \overline{A(\overline{N+_YM})} \ar[r]^{\mc M'} &
	A(\overline{N+_YM}) \ar[r]^{Am_{N+_YM}} & A(N+_YM) \ar@{<->}[u]_{\sim}
      }
    \end{aligned}
    %\tag{$\ast$}
  \]
  The morphisms labelled $\mc E'$ lie in $\mc E'$, and similarly for $\mc M'$;
  these are given by the factorisation system on $\mc C'$.  The maps
  $Am_{N+_YM}$ and $m'_{AN}+_{AY}m'_{AM}$ lie in $\mc M'$ too: $Am_{N+_YM}$ as
  it is in the image of $\mc M$, and $m'_{AN}+_{AY}m'_{AM}$ as $\mc M'$ is
  stable under pushout. 

  Moreover, the diagram commutes as both maps $AX+AZ \to AN+_{AY}AM$ compose to
  that given by the pushout of the images of $f$ and $g$ over $AY$.  Thus the
  diagram represents two $(\mc E', \mc M')$ factorisations of the same morphism,
  and there exists an isomorphism $n$ between the corelations $\square(g) \circ
  \square(f)$ and $\square(g\circ f)$. This proves that $\square$ preserves
  composition.
\end{proof}

\begin{lemma}
  The maps $\kappa$ above are natural.
\end{lemma}
\begin{proof}
  Let $f = (X \longrightarrow N \longleftarrow Y)$, $g= (Z \longrightarrow M
  \longleftarrow W)$ be corelations in $\mc C$. We wish to show that
  \[
      \xymatrixcolsep{4pc}
      \xymatrixrowsep{2pc}
    \xymatrix{
      A(X)+A(Y) \ar[r]^{\square(f)+\square(g)}
      \ar[d]_{\kappa_{X,Y}} & 
      A(Z)+A(W) \ar[d]^{\kappa_{Z,W}} \\
      A(X+Y) \ar[r]^{\square(f+g)} & A(Z+W)
    }
  \]
  commutes. Consider the diagram
  \[
      \xymatrixcolsep{4pc}
      \xymatrixrowsep{2pc}
    \xymatrix{
      (AX+AY)+(AZ+AW) \ar[r]^{\mc E'+\mc E'} \ar[d]_{\kappa_{X,Y}+\kappa_{Z,W}} & 
      \overline{AN}+\overline{AM} \ar[r]^{\mc M'+\mc M'} \ar@{.>}[d]^{n} & 
      AN+AM \ar[d]^{\kappa_{N,M}}\\
      A(X+Y)+A(Z+W) \ar[r]^{\mc E'} & \overline{A(N+M)} \ar[r]^{\mc M'} & A(N+M)
    }
  \]
  This diagram represents two different factorisations of the coproduct of the
  images of $f$ and $g$, and hence commutes. The top edge is the coproduct of
  the respective factorisations of $f$ and $g$, whereas the bottom edge is the
  factorisation of the coproduct of $f$ and $g$. 
  
  Note that by Lemma \ref{lem.monfact} the coproduct of two maps in $\mc E'$ is
  again in $\mc E'$, while Lemma \ref{lem.mcoproductsmc} implies the same for
  $\mc M'$. Thus the top edge is an $(\mc E',\mc M')$-factorisation, and the
  uniqueness of factorisations gives the isomorphism $n$. This proves the
  naturality of the maps $\kappa$.
\end{proof}

These lemmas now imply that $\corel(\mc C)$ is a well-defined hypergraph
category.
\begin{proof}[Proof of Theorem \ref{thm.cospantocorel}]
  To complete the proof then, consider the case of Proposition
  \ref{prop.corelfunctors} with $\mc C = \mc C'$, $(\mc E,\mc M) = (\mc C, \mc
  I_{\mc C})$, and $A = 1_{\mc C}$. Then the domain of $\square$ is $\cospan(\mc
  C)$ by definition. In this case, the function $\square\maps \cospan(\mc C) \to
  \corel(\mc C)$ is bijective-on-objects and surjective-on-morphisms. Moreover,
  note that by definition this function maps the coherence and hypergraph maps
  of $\cospan(\mc C)$ onto the corresponding maps of $\corel(\mc C)$. As
  $\cospan(\mc C)$ is a hypergraph, and $\square$ preserves composition and
  respects the monoidal and hypergraph structure, $\corel(\mc C)$ is also a
  hypergraph category. 
  
  For instance, suppose we want to check the functoriality of the monoidal
  product $+$. We then wish to show $(g \circ f) + (k \circ h) = (g + k) \circ
  (f + h)$ for corelations of the appropriate types.  But $\square$ preserves
  composition, and the naturality of $\kappa$, here the identity map, implies
  that for any two cospans the $\mc E$-part of their coproduct is equal to the
  coproduct of their $\mc E$-parts. Thus we may compute these two expressions by
  viewing $f$, $g$, $h$, and $k$ as cospans, evaluating them in the category of
  cospans, and then taking their $\mc E$-parts. Since the equality holds in the
  category of cospans, it holds in the category of corelations.
\end{proof}

\begin{corollary}
  There is a strict hypergraph functor 
  \[
    \square\maps \mathrm{Cospan}(\mathcal C) \longrightarrow \mathrm{Corel}(\mathcal C)
  \]
  that takes each object of $\cospan(\mathcal C)$ to itself as an object of
  $\corel(\mathcal C)$ and each cospan to its $\mathcal E$-part.
\end{corollary}


Finally, we complete the proof that we have hypergraph functors.
\begin{proof}[Proof of Proposition \ref{prop.corelfunctors}]
  The identity corelation is given by the $\mc E$-part of $[1,1]\maps X+X \to
  X$.
  As the coherence maps for $\square$ are just those of the functor $A$, they
  obey the coherence laws for symmetric monoidal functors.
  
  As for the hypergraph structure, for example the Frobenius multiplication
  $[1_X,1_X]$ (THIS IS NOT THE MULT) on an object $X$ of $\mc C$ obeys
  $A[1_X,1_X] \circ \kappa_{X,X}= [1_{AX},1_{AX}]$, as required.   

\end{proof}

\begin{example}
NEEDS ATTENTION> Note that if both $(\mathcal E, \mathcal M)$ and $(\mathcal E', \mathcal M')$
are epi-mono factorisations, then we always have that $F(\mathcal E) \subseteq
\mathcal E'$ and $F(\mathcal M) \subseteq \mathcal M'$. Indeed, if an
(one-sided) inverse exists in the domain category, it exists in the codomain
category. Thus colimit-preserving functors between categories with finite
colimits and epi-mono factorisation systems also induce a functor between the
epi-mono corelation categories.
\end{example}

\subsection{Example: equivalence relations as corelations in $\Set$}
  
  In each factorisation system of Examples \ref{ex.corels} the right factor
  $\mathcal M$ is stable under pushout.  This gives the hypergraph categories of
  cospans in $\mc C$, the indiscrete category on the objects of $\mc C$, and
  equivalence relations between finite sets. 

  The last of these examples is perhaps the most instructive for black-boxing
  open systems.

  An \define{extraspecial commutative Frobenius monoid}
  $(X,\mu,\eta,\delta,\epsilon)$ in a monoidal category $(\mathcal C, \otimes)$
  is a special commutative Frobenius monoid that further obeys the extra law
  \[
    \extral{.1\textwidth} = \extrar{.1\textwidth}
  \]

The extra law is a recent discovery, appearing first under this name in the
work of Baez and Erbele \cite{BE}, as the `bone law' in \cite{BSZ,FRS}, and as
the `irredundancy law' in \cite{Za}.

Observe that each of these equations equate string diagrams that connect
precisely the same elements of the domain and codomain. To wit, the
associativity, coassociativity, and Frobenius laws show that the order in which
we build a connected component through pairwise clustering is irrelevant, the
special law shows that having multiple connections between points is irrelevant,
and the extra law shows that `extra' components not connected to the domain or
codomain are irrelevant. 

In fact the converse holds: two morphisms built from the generators of an
extraspecial commutative Frobenius monoid are equal and if and only if their
diagrams impose the same connectivity relations on the disjoint union of the
domain and codomain. This is an extension of the spider
theorem for special commutative Frobenius monoids. 

\subsection{Example: linear relations as corelations in $\Vect$}

Recall that a linear relation $L\maps U \leadsto V$ is a subspace $L \subseteq
U \oplus V$. We compose linear relations as we do relations, and vector spaces
and linear relations form a category $\LinRel$. This category can be
constructed as the category of relations in the category $\Vect$ of
vector spaces and linear maps with respect to epi-mono factorisations. We show
that they may also be constructed as corelations in $\Vect$ with respect to
epi-mono factorisations.

If we restrict to the full subcategory $\FinVect$ of finite dimensional vector
spaces this is easy to see: after picking a basis for each vector space the
transpose yields an equivalence of $\FinVect$ with its opposite category, so
the category of $(\mathcal E,\mathcal M)$-corelations (jointly-epic cospans)
is isomorphic to the category of $(\mathcal E,\mathcal M)$-relations
(jointly-monic spans) in $\FinVect$. This fact has been fundamental in work on
finite dimensional linear systems and signal flow diagrams \cite{BE,BSZ,FRS}.

We prove the general case in detail. To begin, note $\mathrm{Vect}$ has an
epi-mono factorisation system with monos stable under pushouts. This
factorisation system is inherited from $\Set$: the epimorphisms in $\Vect$ are
precisely the surjective linear maps, the monomorphisms are the injective
linear maps, and the image of a linear map is always a subspace of the
codomain, and so itself a vector space. Monos are stable under pushout as the
pushout of a diagram $V \stackrel{f}{\leftarrow} U \stackrel{m}{\rightarrow}
W$ is $V \oplus W/\im[f\; -g]$. The map $m'\maps V \to V \oplus W/\im[f\; -g]$
into the pushout has kernel $f(\ker m)$. Thus when $m$ is a monomorphism, $m'$
is too.

Thus we have a category of corelations $\corel(\Vect)$. We show that the map
$\corel(\Vect) \to \LinRel$ sending each vector space to itself and each
corelation
\[
  U \xrightarrow{f} A \xleftarrow{g} V
\]
to the linear subspace $\ker[f\;-g]$ is a full, faithful, and
bijective-on-objects functor.

Indeed, corelations $U \xrightarrow{f} A \xleftarrow{g} V$ are in one-to-one
correspondence with surjective linear maps $U\oplus V \to A$, which are in
turn, by the isomorphism theorem, in one-to-one correspondence with subspaces
of $U\oplus V$. These correspondences are described by the kernel construction
above. Thus our map is evidently full, faithful, and bijective-on-objects. It
also maps identities to identities. It remains to check that it preserves
composition.

Suppose we have corelations $U \xrightarrow{f} A \xleftarrow{g} V$
and $V \xrightarrow{h} B \xleftarrow{k} W$. Then their pushout is given by
$P=A \oplus B/\im[g\;-h]$, and we may draw the pushout diagram
\[
  \xymatrix{
    U \ar[dr]_{f} & & V \ar[dl]^{g}  
    \ar[dr]_{h} & & W \ar[dl]^{k} {} 
    \\
    & A \ar[dr]_{\iota_A} & & B \ar[dl]^{\iota_B}  \\
    & & P {\save*!<0cm,-.5cm>[dl]@^{|-}\restore}
  }
\]
We wish to show the equality of relations
\[
  \ker[f\;-g];\ker[h\;-k] = \ker[\iota_A f\; -\iota_B g].
\]
Now $(\mathbf{u},\mathbf{w}) \in U \oplus W$ lies in the composite relation
$\ker[f\;-g];\ker[h\;-k]$ iff there exists $\mathbf{v} \in V$ such that
$f\mathbf{u} = g\mathbf{v}$ and $h\mathbf{v} = k\mathbf{w}$. But as $P$ is the
pushout, this is true iff 
\[
  \iota_A f \mathbf{u} = \iota_A g \mathbf{v} = \iota_B h \mathbf{v} =
  \iota_B k \mathbf{w}.
\]
This in turn is true iff $(\mathbf{u}, \mathbf{w}) \in \ker[\iota_Af\;
-\iota_Bk]$, as required. 



\section{Decorated corelations} \label{sec:dcorc}

When enough structure is available to us, we may decorate corelations too.
Furthermore, and key to the idea of `black-boxing', we get a hypergraph functor
from decorated cospans to decorated corelations.


\subsection{Adjoining right adjoints}
Suppose we have a cospan $X+Y \to N$ with a decoration on $N$. Reducing this to
a corelation requires us to factor this to $X+Y \stackrel{e}\to \overline{N}
\stackrel{m}\to N$. Decorated corelations require a method from taking a
decoration on $N$ and `pulling it back' along $m$ to a decoration on
$\overline{N}$. 

A subcategory stable under pushouts is a useful thing.

\begin{proposition}
  Let $\mathcal C$ be a category with finite colimits, and let $\mathcal M$ be a
  subcategory of $\mathcal C$ stable under pushouts. Then we define the category
  $\mathcal C; \mathcal M^\opp$ as follows  
  \begin{center}
    \begin{tabular}{| c | p{.65\textwidth} |}
      \hline
      \multicolumn{2}{|c|}{The symmetric monoidal category $(\mc C;\mc M^\opp,+)$} \\
      \hline
      \textbf{objects} & the objects of $\mathcal C$ \\ 
      \textbf{morphisms} & isomorphism classes of cospans of the form
      $\stackrel{c}\rightarrow \stackrel{m}\leftarrow$, where $c$ is a morphism
      in $\mathcal C$ and $m$ a morphism in $\mathcal M$\\ 
      \textbf{composition} & given by pushout \\
      \textbf{monoidal product} & the coproduct in $\mathcal C$ \\
      \textbf{coherence maps} & the coherence maps in $\mc C$ \\
      \hline
    \end{tabular}
  \end{center}
\end{proposition}
\begin{proof}
  Composition is well-defined as $\mc M$ is stable under pushouts. Monoidal
  composition is well-defined by Lemma \ref{lem.mcoproductsmc}. Necessary laws
  hold as they are inherited from $\mc C$. 
\end{proof}

This category can be viewed as a bicategory, with 2-morphisms given by maps of
cospans. In this bicategory every morphism of $\mc M$ has a right adjoint.

\begin{examples}
  \begin{itemize}
    \item Note that $\mathcal C; \mathcal C^\opp$ is by definition equal to
      $\cospan(\mathcal C)$. 

    \item Writing $\mathcal I_{\mathcal C}$ for the wide subcategory of
      isomorphisms in $\mathcal C$, note that $\mathcal C;\mathcal I_{\mathcal
      C}^\opp$ is naturally isomorphic to $\mathcal C$.
  \end{itemize}
\end{examples}

\begin{lemma}
  Let $\mathcal C$, $\mathcal C'$ be categories with finite colimits, and let
  $\mathcal M$, $\mathcal M'$ be subcategories each stable under pushouts. Let
  $A\maps \mathcal C \to \mc C'$ be functor that preserves colimits and such
  that the image of $\mc M$ lies in $\mc M'$. Then $A$ extends to a symmetric
  (strong) monoidal functor
  \[
    A\maps \mc C;\mc M^\opp \longrightarrow \mc C'; \mc M'^\opp.
  \]
  mapping $X$ to $AX$ and $\stackrel{c}\rightarrow \stackrel{m}\leftarrow$ to
  $\stackrel{Ac}\rightarrow \stackrel{Am}\leftarrow$.
\end{lemma}
\begin{proof}
  Note $A(\mc M) \subseteq \mc M'$, so $\stackrel{Ac}\rightarrow
  \stackrel{Am}\leftarrow$ is indeed a morphism in $\mc C';\mc M'$. The functor
  $A$ preserves colimits, so composition is preserved.
\end{proof}

Note this could be done more generally with any two isomorphism-containing wide
subcategories stable under pushout.

\subsection{Decorated corelations}

\begin{definition}
  Let $\mathcal C$ be a category with finite colimits, and let $(\mathcal E,
  \mathcal M)$ be a factorisation system on $\mathcal C$. Suppose that we also
  have a lax monoidal functor
  \[
    F: (\mathcal C;\mathcal M^\opp,+) \longrightarrow (\Set, \times).
  \]
  Then we define an $F$-\define{decorated corelation} to be the isomorphism
  class of a pair
  \[
    \left(
    \begin{aligned}
      \xymatrix{
	& N \\  
	X \ar[ur]^{i} && Y \ar[ul]_{o}
      }
    \end{aligned}
    ,
    \qquad
    \begin{aligned}
      \xymatrix{
	FN \\
	1 \ar[u]_{s}
      }
    \end{aligned}
    \right)
  \]
  where the cospan is jointly-$\mathcal E$-like.
\end{definition}

Again, we will be lazy about the distinction between a decorated corelation and
its isomorphism class.

Suppose we have decorated corelations
  \[
    \left(
    \begin{aligned}
      \xymatrix{
	& N \\  
	X \ar[ur]^{i} && Y \ar[ul]_{o}
      }
    \end{aligned}
    ,
    \qquad
    \begin{aligned}
      \xymatrix{
	FN \\
	1 \ar[u]_{s}
      }
    \end{aligned}
    \right)
    \qquad
    \mbox{and}
    \qquad
    \left(
    \begin{aligned}
      \xymatrix{
	& M \\  
	Y \ar[ur]^{i} && Z \ar[ul]_{o}
      }
    \end{aligned}
    ,
    \qquad
    \begin{aligned}
      \xymatrix{
	FM \\
	1 \ar[u]_{s}
      }
    \end{aligned}
    \right).
  \]
  Then their composite is given by the composite corelation
  \[
    \xymatrix{
      & \overline{N+_YM} \\  
      X \ar[ur]^{i} && Z \ar[ul]_{o}
    }
  \]
  paired with the decoration
  \[
    1 \longrightarrow F(N+M) \longrightarrow F(N+_YM) \stackrel{F(m^\opp)}\longrightarrow F(\overline{N+_YM})
  \]
  This is well-defined.

\subsection{Categories of decorated corelations.}
\begin{theorem}
  Let $\mathcal C$ be a category with finite colimits and factorisation system
  $(\mathcal E, \mathcal M)$ with $\mathcal M$ stable under pushout, and let 
  \[
    F: (\mathcal C;\mathcal M^\opp,+) \longrightarrow (\Set, \times)
  \]
  be a symmetric lax monoidal functor.  Then we may define 
  \begin{center}
    \begin{tabular}{| c | p{.65\textwidth} |}
      \hline
      \multicolumn{2}{|c|}{The hypergraph category $(F\mathrm{Corel},+)$} \\
      \hline
      \textbf{objects} & the objects of $\mathcal C$ \\ 
      \textbf{morphisms} & isomorphism classes of $F$-decorated corelations in
      $\mathcal C$\\ 
      \textbf{composition} & given by $\mc E$-part of pushout with restricted
      decoration  \\
      \textbf{monoidal product} & the coproduct in $\mathcal C$ on objects, coproduct
      of cospans and pair of decorations on morphisms. \\
      \textbf{coherence maps} & maps from $\cospan(\mc C)$ with restricted empty
      decoration \\
      \textbf{hypergraph maps} & maps from $\cospan(\mc C)$ with restricted empty
      decoration \\
      \hline
    \end{tabular}
  \end{center}
\end{theorem}
Similar to the corelations theorem (Theorem \ref{thm.cospantocorel}), we prove
this alongside the theorem in the next subsection.
\begin{example}
  Note that decorated cospans are a special case of decorated corelations: we
  use an morphism--isomorphism factorisation system.
\end{example}

\begin{example} \label{ex.undeccorel}
  Note that `undecorated' corelations are a special case of decorated
  corelations: they are corelations decorated by the functor $1\maps \mc C;\mc
  M^\opp \to \Set$ that maps each object to the one element set $1$, and each
  morphism to the identity function on $1$. This is a symmetric monoidal functor
  with the coherence maps all also the identity function on $1$.
\end{example}

The key difference is to decorate cospans we need to know how to push
decorations up. To decorate corelations we all need to know how to pull
decorations back down. This is related to the existence of an extraspecial
commutative Frobenius monoid in our main applications.


Associativity: To take a decoration on $A+B$ to one on $A+_C\overline B$ we may
either reduce to the $\mathcal E$-part of $B$ and then pushout over $C$, or
pushout over $C$ and then reduce to the $\mathcal E$ part of $B$. This lemma
implies that both processes result in the same decoration.  \subsection{Functors
between decorated corelation categories}

\begin{proposition}\label{prop.deccorelfunctors}
  Let $\mathcal C$, $\mathcal C'$ have finite colimits and respective
factorisation systems $(\mathcal E, \mathcal M)$, $(\mathcal E', \mathcal M')$,
such that $\mathcal M$ and $\mathcal M'$ are stable under pushout, and suppose
that we have symmetric lax monoidal functors
\[
  F: (\mathcal C;\mathcal M^\opp,+) \longrightarrow (\Set, \times)
\]
and
\[
  G: (\mathcal C';\mathcal M'^\opp,+) \longrightarrow (\Set, \times).
\]

Further let $A\maps \mathcal C \to \mathcal C'$ be a functor that preserves
finite colimits and such that the image of $\mathcal M$ lies in $\mathcal M'$.
This functor $A$ extends to a symmetric monoidal functor $\mc C;\mc M^\opp \to
\mc C';\mc M'^\opp$.

Suppose we have a monoidal natural transformation $\theta$:
\[
  \xymatrixrowsep{2ex}
  \xymatrix{
    \mc C; \mc M^\opp \ar[dd]_{A} \ar[drr]^F  \\
    &\twocell \omit{_\:\theta}& \Set \\
    \mc C'; \mc {M'}^\opp \ar[urr]_{G} 
  }
\]

Then we may define a hypergraph functor $T\maps F\mathrm{Corel} \to
G\mathrm{Corel}$ sending each object $X \in F\mathrm{Corel}$ to $AX \in
G\mathrm{Corel}$ and each decorated corelation 
\[
  X \stackrel{i_X}{\longrightarrow} N \stackrel{o_Y}{\longleftarrow} Y, \quad
  1 \stackrel{s}{\to} FN
\]
to
\[
  AX \stackrel{Ai_X}{\longrightarrow} \overline{AN} \stackrel{Ao_Y}{\longleftarrow} AY,
  \quad 1 \stackrel{s}{\to} FN \stackrel{\theta_N}{\to} GAN
  \stackrel{Gm_{AN}^\opp}{\to} G\overline{AN}.	
\]
The coherence maps are given by
\[
  \kappa_{X,Y}=          
  \left(
  \begin{aligned}
    \xymatrix{
      & \overline{A(X+Y)} \\  
      AX+AY \ar[ur] && A(X+Y) \ar[ul]
    }
  \end{aligned}
  ,
  \qquad
  \begin{aligned}
    \xymatrixrowsep{1.4ex}
    \xymatrix{
      G(\overline{A(X+Y)}) \\
      GA(X+Y) \ar[u]_{Gm_{AX+AY}^\opp} \\
      G\varnothing \ar[u]_{G!} \\
      1 \ar[u]_{\gamma_1}
    }
  \end{aligned}
  \right).
\]
\end{proposition}
\begin{proof}
  In the proof of Proposition \ref{prop.corelfunctors} we used the existence of a
  bijective-on-objects, surjective-on-morphisms, composition preserving map
  $\mathrm{Cospan}(\mathcal C) \to\mathrm{Corel}(\mathcal C)$ to prove the
  associativity and other properties of $\mathrm{Corel}(\mathcal C)$. Our proof
  strategy here is entirely analogous.

  Similar to before, we still have not proved that decorated corelations form
  well-defined hypergraph categories. So we begin by merely showing that the map
  $\square$ is composition-preserving, and then that $\square$ respects the
  monoidal and hypergraph structure. We then specialise to the case where the
  domain forms a decorated cospan category that maps surjectively onto a generic
  decorated corelations codomain. Since we know decorated cospan categories are
  well-defined hypergraph categories, we can conclude the same for decorated
  corelations categories, and hence prove that $\square$ is a hypergraph functor. 
  
  We prove that $\square$ preserves composition. Suppose we have decorated corelations
  \[
    X \stackrel{i_X}{\longrightarrow} N \stackrel{o_Y}{\longleftarrow} Y, \quad
    1 \stackrel{s}{\to} FN
    \qquad
    \mbox{and}
    \qquad 
    Y \stackrel{i_Y}{\longrightarrow} M \stackrel{o_Y}{\longleftarrow} Z, \quad
    1 \stackrel{t}{\to} FM
  \]
%  \[
%    \left(
%    \begin{aligned}
%      \xymatrix{
%	& N \\  
%	X \ar[ur]^{i} && Y \ar[ul]_{o}
%      }
%    \end{aligned}
%    ,
%    \qquad
%    \begin{aligned}
%      \xymatrix{
%	FN \\
%	1 \ar[u]_{s}
%      }
%    \end{aligned}
%    \right)
%    \qquad
%    \mbox{and}
%    \qquad
%    \left(
%    \begin{aligned}
%      \xymatrix{
%	& M \\  
%	Y \ar[ur]^{i} && Z \ar[ul]_{o}
%      }
%    \end{aligned}
%    ,
%    \qquad
%    \begin{aligned}
%      \xymatrix{
%	FM \\
%	1 \ar[u]_{s}
%      }
%    \end{aligned}
%    \right).
%  \]
  We know the functor $\square$ preserves composition on the cospan part; this
  is precisely the content of Proposition \ref{prop.corelfunctors}. It remains to
  check that $\square( g \circ f)$ and $\square g \circ \square f$ have
  isomorphic decorations. This is expressed by the commutativity of the
  following diagram:
  \[
    \xymatrixrowsep{1.1pc}
    \xymatrixcolsep{0pc}
    \xymatrix{
      G\overline{A(\overline{N+_YM})} \ar[rrrrrr]^{Gn} &&&&&&
      G\overline{(\overline{AN}+_{AY}\overline{AM})}\\
      \\
      GA(\overline{N+_YM}) \ar[uu]^{Gm^\opp_{A(\overline{N+_YM})}} &&&
      \textsc{\tiny($\ast\ast$)} &&& 
      G(\overline{AN}+_{AY}\overline{AM}) \ar[uu]_{Gm^\opp_{\overline{AN}+_{AY}\overline{AM}}} \\
      \\
      F(\overline{N+_YM}) \ar[uu]^{\theta_{\overline{N+_YM}}} & %\textsc{\tiny()} & 
      &
      GA(N+_YM) \ar[uull]_{GAm^\opp_{N+_YM}} && 
      G(AN+_{AY}AM) \ar[ll]_{G\sim} \ar[uurr]^{G(m_{AN}^\opp +_{AY}m_{AM}^\opp)}
      & \textsc{\tiny(c)} & 
      G(\overline{AN}+\overline{AM}) \ar[uu]_{G[j_{\overline{AN}},j_{\overline{AM}}]} 
      \\
      &\textsc{\tiny(tn)}&& \textsc{\tiny(a)} 
      \\
      F(N+_YM) \ar[uu]^{Fm_{N+_YM}^\opp} %\ar[uurr]_{\theta_{N+_YM}} & \textsc{\tiny()} & 
      &&
      GA(N+M)\ar[uu]_{GA[j_N,j_M]} && 
      G(AN+AM) \ar[uu]^{G[j_{AN},j_{AM}]} \ar[ll]^{G\alpha_{N,M}}
      \ar[uurr]^{G(m_{AN}^\opp +m_{AM}^\opp)} & \textsc{\tiny(gm)} & 
      G\overline{AN} \times G\overline{AM}
      \ar[uu]_{\gamma_{\overline{AN},\overline{AM}}} \\
      \\
      F(N+M) \ar[uu]^{F[j_N,j_M]} \ar[uurr]_{\theta_{N+M}} &&& \textsc{\tiny(tm)} &&& 
      GAN \times GAM \ar[uu]_{Gm_{AN}^\opp \times Gm_{AM}^\opp}
      \ar[uull]^{\gamma_{AN,AM}} \\
      \\
      &&&FN \times FM \ar[uulll]^{\varphi_{N,M}} \ar[uurrr]_{\theta_N \times
      \theta_M} \\\\
      &&&1 \ar[uu]_{\rho_1\circ (s \times t)}
    }
  \]
  This diagram does indeed commute. To check this, first observe that \textsc{(tm)}
  commutes by the monoidality of $\theta$, \textsc{(gm)} commutes by the
  monoidality of $G$, and \textsc{(tn)} commutes by the naturality of $\theta$.
  The remaining three diagrams commute as they are $G$-images of diagrams that
  commute in $\mc C';\mc M'^\opp$. Indeed, \textsc{(a)} commutes since $A$ preserves
  colimits and $G$ is functorial, \textsc{(c)} commutes as it is the $G$-image
  of a pushout square in $\mc C'$, so 
  \[
    \stackrel{m_{AN}^\opp+m_{AM}^\opp}{\longleftarrow} 
    \stackrel{[j_{\overline{AN}},j_{\overline{AM}}]}{\longrightarrow}
    \quad 
    \textrm{and}
    \quad
    \stackrel{[j_{AN},j_{AM}]}{\longrightarrow}
    \stackrel{m_{AN}^\opp+_{AY}m_{AM}^\opp}{\longleftarrow} 
  \]
  are equal as morphisms of $\mc C';\mc M'^\opp$, and \textsc{($\ast\ast$)} commutes
  as it is the $G$-image of the right-hand subdiagram of $(\ast)$ used to define
  $n$.
  
  It is evident that $\square$ is bijective-on-objects and
  surjective-on-morphisms. This proves the theorem.
\end{proof}

%  \[
%    \xymatrixrowsep{1pc}
%    \xymatrixcolsep{1pc}
%    \xymatrix{
%      &&&& F(N+M) \ar[dd]^{F((m_N +m_M)^\opp)} \ar[rr]^{F[j_N,j_M]} 
%      && F(N+_YM) \ar[dd]^{F((m_N+_Ym_M)^\opp)} \ar[rr]^{F((m_{N+_YM})^\opp)} 
%      && F(\overline{N+_YM}) \ar[dd]^{Fn}_\sim \\ 
%      1 \ar[rr]^(.4){(s\times t)\circ\lambda^{-1}} 
%      && FN\times FM \ar[urr]^{\varphi} \ar[dr]_{Fm_N^\opp\times Fm_M^\opp} &
%      \qquad\textrm{\tiny(I)}% && \textrm{\tiny(F)} && \textrm{\tiny(C)}
%      \\ 
%      &&& F\overline{N} \times F\overline{M} \ar[r]_{\varphi} 
%      & F(\overline{N}+\overline{M})
%      \ar[rr]_{F[j_{\overline{N}},j_{\overline{M}}]} 
%      && F(\overline{N}+_Y\overline{M})
%      \ar[rr]_{F((m_{\overline{N}+_Y\overline{M}})^\opp)} 
%      && F(\overline{\overline{N}+_Y\overline{M}})
%    }
%  \]
%  Here $n$ is the isomorphism from the proof of Proposition
%  \ref{prop.corelfunctors}.
%  The leftmost square (I) commutes by the naturality of $\varphi$, the central
%  square commutes as it is the $F$-image of a pushout square in $\mathcal C$,
%  and rightmost square commutes as it is the $F$-image of the rightmost square
%  in the commutative diagram (\ref{diag.eparts}) in $\mathcal M^\opp$.
  


\begin{corollary}
  Let $\mathcal C$ be a category with finite colimits, and let $(\mathcal E,
  \mathcal M)$ be a factorisation system on $\mathcal C$. Suppose that we also
  have a lax monoidal functor
  \[
    F: (\mathcal C;\mathcal M^\opp,+) \longrightarrow (\Set, \times).
  \]
  Then we may define a category $F\mathrm{Corel}$ with objects the objects of
  $\mathcal C$ and morphisms isomorpism classes of $F$-decorated corelations.

  Write also $F$ for the restriction of $F$ to the wide subcategory $\mathcal
  C$ of $\mathcal C;\mathcal M^\opp$. We can thus also obtain the category
  $F\mathrm{Cospan}$ of
  $F$-decorated cospans. We moreover have a functor 
  \[
    F\mathrm{Cospan} \to F\mathrm{Corel}
  \]
  which takes each object of $F\mathrm{Cospan}$ to itself as an object of
  $F\mathrm{Corel}$, and each decorated cospan
  \[
    \left(
    \begin{aligned}
      \xymatrix{
	& N \\  
	X \ar[ur]^{i} && Y \ar[ul]_{o}
      }
    \end{aligned}
    ,
    \qquad
    \begin{aligned}
      \xymatrix{
	FN \\
	1 \ar[u]_{s}
      }
    \end{aligned}
    \right)
  \]  
  to its jointly-$\mathcal E$-part
  \[
    \xymatrix{
      & \overline{N} \\  
      X \ar[ur]^{i} && Y \ar[ul]_{o}
    }
  \]
  decorated by the composite
  \[
    \xymatrix{
      1 \ar[r]^s & FN \ar[r]^{Fm_N^\opp} & F\overline{N}.
    }
  \]
\end{corollary}


\section{All hypergraph categories are decorated corelation categories}
structured categories are algebras over their graphical calculus operad
\cite{SSR}. These equivalences are 2-categorical.

Write $\int$ for the Grothendieck construction. The Grothendieck construction
is

\begin{theorem}
hypergraph categories are symmetric lax monoidal functors cospan to Set.
\[
  \mathrm{HypCat} \cong \int^{\mc O \in \Set}
  \mathrm{SymLaxMon}(\cospan(\FinSet_{\mc O}), \Set)
\]
\end{theorem}
\cite{SV}
\begin{remark}
Not all hypergraph categories are decorated \emph{cospan} categories. To see
this, we can count morphisms. The possible apices and decorations are the same
for all morphisms. So for a decorated cospan category over the prop of finite
sets, the number of morphisms $0 \to 1$ cannot be more than countably many times
those $0 \to 0$ (we just get to choose an element of the apex). But the skeletal
category of vector spaces over $\mathbb{R}$ with monoidal product the tensor
product has $\mathbb{R}$ morphisms $0 \to 0$, and $\mathbb{R}^2$ morphisms $0
\to 1$.
\end{remark}

Decorated corelation categories, however, are more powerful. We can recover all
hypergraph categories by forcing the decorations to be on the coproduct of the
domain and codomain itself. For this we use the isomorphism--morphism
factorisation. Let $\mc H$ be a hypergraph category, and let $\mc C$ be the wide
subcategory of all Frobenius morphisms. Then $\mc H$ can be recovered as the
$(\mc I_{\mc C},\mc C)$-corelations decorated by global sections in $\mc H$.

\subsection{The global sections construction.}

\begin{theorem}
  All hypergraph categories are decorated corelation categories.
\end{theorem}
\begin{proof}
  Let $\mc H$ be a hypergraph category. Without loss of generality we can assume
  $\mc H$ has objects a free monoid under the tensor product; write $\mc O$ for
  a collection of generators for this free monoid, and $\FinSet_{\mc O}$ for
  $\mc O$ labelled finite sets (ie an object is a finite set $X$ together with a
  function $X \to \mc O$). This is a finitely cocomplete category. Equivalent to
  finite lists of objects in $\mc H$. 

  Define the global sections functor 
  \begin{align*}
    G\maps \cospan(\FinSet_{\mc O}) &\longrightarrow \Set \\
    A &\longmapsto \mc H(I,A) \\
    \stackrel{f}{\to}\stackrel{g}{\leftarrow} &\longmapsto \textrm{action of
    Frobenius maps}
  \end{align*}
  This is symmetric lax monoidal functor. Note that $\mc H(I,A)$ depends on the
  order we choose to convert a multiset into an object $A$ of $\mc H$.
  Nonetheless, from any two choices $A$, $A'$ we get a canonical map $A \to A'$.
  This is really that clique in $\Set$.

  Consider the category $\FinSet_{\mc O}$ with an
  (isomorphism,morphism)-factorisation system. We get a decorated corelations
  category with objects multisets of generating objects of $\mc H$, and morphisms $A \to
  B$ trivial corelations $A \to A+B \leftarrow B$ decorated by some morphism
  $s \in \mc H(I,A+B)$. Recall that this decorated corelation is only specified
  up to isomorphism; in the following we always choose representatives such that
  the apex of the jointly-isomorphic cospan is always of the form $A+B$ for
  morphisms $A \to B$.
  
  Given morphisms $s \in \mc H(I,A+B)$ and $t \in \mc H(I,B+C)$ of types $A \to
  B$ and $B \to C$ in $G\mathrm{Corel}$, composition is given by the map
  $H(I,A+B+B+C) \to H(I,A+C)$ arising as the $G$-image of the cospan $A+B+B+C
  \stackrel{[j,j]}\rightarrow A+B+C \stackrel{m}\leftarrow A+C$ where maps come
  from the pushout square
  \[
    \xymatrix{
      && A+C \ar[d] \\
      && A+B+C \\
      & A+B \ar[ur] && B+C \ar[ul] \\
      A \ar[ur] && B \ar[ul]\ar[ur] && C \ar[ul]
    }
  \]
  
  In terms of string diagrams in $\mc H$, this means composing the maps 
  \[
    \tikzset{every path/.style={line width=1.1pt}}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.25, 0.375) {};
		\node [style=none] (1) at (0.5, 0.375) {};
		\node [style=none] (2) at (-0.25, -0.375) {};
		\node [style=none] (3) at (0.5, -0.375) {};
		\node [style=none] (4) at (0.5, 0.25) {};
		\node [style=none] (5) at (0.5, -0.25) {};
		\node [style=none] (6) at (1.25, 0.25) {};
		\node [style=none] (7) at (1.25, -0.25) {};
		\node [style=none] (8) at (0.125, -0) {$s$};
		\node [style=none] (9) at (1.5, 0.25) {$A$};
		\node [style=none] (10) at (1.5, -0.25) {$B$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (3.center);
		\draw (3.center) to (2.center);
		\draw (2.center) to (0.center);
		\draw (4.center) to (6.center);
		\draw (5.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
\qquad 
\qquad
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.25, 0.375) {};
		\node [style=none] (1) at (0.5, 0.375) {};
		\node [style=none] (2) at (-0.25, -0.375) {};
		\node [style=none] (3) at (0.5, -0.375) {};
		\node [style=none] (4) at (0.5, 0.25) {};
		\node [style=none] (5) at (0.5, -0.25) {};
		\node [style=none] (6) at (1.25, 0.25) {};
		\node [style=none] (7) at (1.25, -0.25) {};
		\node [style=none] (8) at (0.125, -0) {$t$};
		\node [style=none] (9) at (1.5, 0.25) {$B$};
		\node [style=none] (10) at (1.5, -0.25) {$C$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (3.center);
		\draw (3.center) to (2.center);
		\draw (2.center) to (0.center);
		\draw (4.center) to (6.center);
		\draw (5.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
  \]
  with the Frobenius map
  \[
    \tikzset{every path/.style={line width=1.1pt}}
    \begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.125, 0.75) {};
		\node [style=none] (1) at (-0.125, 0.25) {};
		\node [style=none] (2) at (-0.125, -0.25) {};
		\node [style=none] (3) at (-0.125, -0.75) {};
		\node [style=none] (4) at (0.5, -0) {};
		\node [style=none] (5) at (1, 0.75) {};
		\node [style=none] (6) at (1, -0.75) {};
		\node [style=none] (8) at (-0.375, 0.75) {$A$};
		\node [style=none] (9) at (-0.375, 0.25) {$B$};
		\node [style=none] (10) at (-0.375, -0.25) {$B$};
		\node [style=none] (11) at (-0.375, -0.75) {$C$};
		\node [style=none] (12) at (1.25, 0.75) {$A$};
		\node [style=none] (13) at (1.25, -0.75) {$C$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (5.center);
		\draw [in=90, out=0, looseness=1.00] (1.center) to (4.center);
		\draw [in=-90, out=0, looseness=1.00] (2.center) to (4.center);
		\draw (3.center) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\quad
=
\quad
\begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.125, 0.75) {};
		\node [style=none] (1) at (-0.125, 0.25) {};
		\node [style=none] (2) at (-0.125, -0.25) {};
		\node [style=none] (3) at (-0.125, -0.75) {};
		\node [style=none] (4) at (0.5, -0) {};
		\node [style=none] (5) at (1.25, 0.75) {};
		\node [style=none] (6) at (1.25, -0.75) {};
		\node [style=circ2] (7) at (1, -0) {};
		\node [style=none] (8) at (-0.375, 0.75) {$A$};
		\node [style=none] (9) at (-0.375, 0.25) {$B$};
		\node [style=none] (10) at (-0.375, -0.25) {$B$};
		\node [style=none] (11) at (-0.375, -0.75) {$C$};
		\node [style=none] (12) at (1.5, 0.75) {$A$};
		\node [style=none] (13) at (1.5, -0.75) {$C$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (5.center);
		\draw [in=90, out=0, looseness=1.00] (1.center) to (4.center);
		\draw [in=-90, out=0, looseness=1.00] (2.center) to (4.center);
		\draw (3.center) to (6.center);
		\draw (4.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
  \]
  to get 
  \[
    \tikzset{every path/.style={line width=1.1pt}}
    \begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.25, 0.375) {};
		\node [style=none] (1) at (0.5, 0.375) {};
		\node [style=none] (2) at (-0.25, -0.375) {};
		\node [style=none] (3) at (0.5, -0.375) {};
		\node [style=none] (4) at (0.5, 0.25) {};
		\node [style=none] (5) at (0.5, -0.25) {};
		\node [style=none] (6) at (1.25, 0.25) {};
		\node [style=none] (7) at (1.25, -0.25) {};
		\node [style=none] (8) at (0.125, -0) {$t\circ s$};
		\node [style=none] (9) at (1.5, 0.25) {$A$};
		\node [style=none] (10) at (1.5, -0.25) {$C$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (3.center);
		\draw (3.center) to (2.center);
		\draw (2.center) to (0.center);
		\draw (4.center) to (6.center);
		\draw (5.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\quad = 
\quad
\begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.875, 0.875) {};
		\node [style=none] (1) at (-0.125, 0.875) {};
		\node [style=none] (2) at (-0.125, 0.125) {};
		\node [style=none] (3) at (-0.875, 0.125) {};
		\node [style=none] (4) at (-0.875, -0.125) {};
		\node [style=none] (5) at (-0.125, -0.125) {};
		\node [style=none] (6) at (-0.125, -0.875) {};
		\node [style=none] (7) at (-0.875, -0.875) {};
		\node [style=none] (8) at (-0.125, 0.75) {};
		\node [style=none] (9) at (-0.125, 0.25) {};
		\node [style=none] (10) at (-0.125, -0.25) {};
		\node [style=none] (11) at (-0.125, -0.75) {};
		\node [style=none] (12) at (0.5, -0) {};
		\node [style=none] (13) at (0.75, 0.75) {};
		\node [style=none] (14) at (0.75, -0.75) {};
		\node [style=none] (15) at (-0.5, 0.5) {$s$};
		\node [style=none] (16) at (-0.5, -0.5) {$t$};
		\node [style=none] (17) at (1, 0.75) {$A$};
		\node [style=none] (18) at (1, -0.75) {$C$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (2.center);
		\draw (2.center) to (3.center);
		\draw (3.center) to (0.center);
		\draw (4.center) to (5.center);
		\draw (5.center) to (6.center);
		\draw (6.center) to (7.center);
		\draw (7.center) to (4.center);
		\draw (8.center) to (13.center);
		\draw [in=90, out=0, looseness=1.00] (9.center) to (12.center);
		\draw [in=-90, out=0, looseness=1.00] (10.center) to (12.center);
		\draw (11.center) to (14.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\]
in $\mc H(I,A+C)$.
  
The monoidal product is given by
  \[
    \tikzset{every path/.style={line width=1.1pt}}
    \begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.25, 0.375) {};
		\node [style=none] (1) at (0.5, 0.375) {};
		\node [style=none] (2) at (-0.25, -0.375) {};
		\node [style=none] (3) at (0.5, -0.375) {};
		\node [style=none] (4) at (0.5, 0.25) {};
		\node [style=none] (5) at (0.5, -0.25) {};
		\node [style=none] (6) at (1.25, 0.25) {};
		\node [style=none] (7) at (1.25, -0.25) {};
		\node [style=none] (8) at (0.125, -0) {$s$};
		\node [style=none] (9) at (1.5, 0.25) {$A$};
		\node [style=none] (10) at (1.5, -0.25) {$B$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (3.center);
		\draw (3.center) to (2.center);
		\draw (2.center) to (0.center);
		\draw (4.center) to (6.center);
		\draw (5.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\quad 
+
\quad
\begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.25, 0.375) {};
		\node [style=none] (1) at (0.5, 0.375) {};
		\node [style=none] (2) at (-0.25, -0.375) {};
		\node [style=none] (3) at (0.5, -0.375) {};
		\node [style=none] (4) at (0.5, 0.25) {};
		\node [style=none] (5) at (0.5, -0.25) {};
		\node [style=none] (6) at (1.25, 0.25) {};
		\node [style=none] (7) at (1.25, -0.25) {};
		\node [style=none] (8) at (0.125, -0) {$t$};
		\node [style=none] (9) at (1.5, 0.25) {$C$};
		\node [style=none] (10) at (1.5, -0.25) {$D$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (3.center);
		\draw (3.center) to (2.center);
		\draw (2.center) to (0.center);
		\draw (4.center) to (6.center);
		\draw (5.center) to (7.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\quad = \quad 
\begin{aligned}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-0.875, 0.875) {};
		\node [style=none] (1) at (-0.125, 0.875) {};
		\node [style=none] (2) at (-0.125, 0.125) {};
		\node [style=none] (3) at (-0.875, 0.125) {};
		\node [style=none] (4) at (-0.875, -0.125) {};
		\node [style=none] (5) at (-0.125, -0.125) {};
		\node [style=none] (6) at (-0.125, -0.875) {};
		\node [style=none] (7) at (-0.875, -0.875) {};
		\node [style=none] (8) at (-0.125, 0.75) {};
		\node [style=none] (9) at (-0.125, 0.25) {};
		\node [style=none] (10) at (-0.125, -0.25) {};
		\node [style=none] (11) at (-0.125, -0.75) {};
		\node [style=none] (12) at (1, 0.75) {};
		\node [style=none] (13) at (1, 0.25) {};
		\node [style=none] (14) at (1, -0.25) {};
		\node [style=none] (15) at (1, -0.75) {};
		\node [style=none] (16) at (-0.5, 0.5) {$s$};
		\node [style=none] (17) at (-0.5, -0.5) {$t$};
		\node [style=none] (18) at (1.25, 0.75) {$A$};
		\node [style=none] (19) at (1.25, 0.25) {$C$};
		\node [style=none] (20) at (1.25, -0.25) {$B$};
		\node [style=none] (21) at (1.25, -0.75) {$D$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
		\draw (1.center) to (2.center);
		\draw (2.center) to (3.center);
		\draw (3.center) to (0.center);
		\draw (4.center) to (5.center);
		\draw (5.center) to (6.center);
		\draw (6.center) to (7.center);
		\draw (7.center) to (4.center);
		\draw (8.center) to (12.center);
		\draw [in=180, out=0, looseness=1.00] (9.center) to (14.center);
		\draw [in=180, out=0, looseness=1.00] (10.center) to (13.center);
		\draw (11.center) to (15.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{aligned}
\]
recalling that we have chosen to represent the equivalence class of corelations
$A+C \to B+D$ with the apex $A+C+B+D$.

  Taking a hint from the compact closed structure, it is straightforward to
  construct a pair of inverse hypergraph functors between $G\mathrm{Corel}$ to $\mc H$.
  Indeed, $G\mathrm{Corel}$ is constructed to have the same collection of
  objects as $\mc H$; simply have the functors be the `identity' on objects. On
  morphisms, we take $f: A \to B$ in $\mc H$ to its `name' $\hat f: I \to A+B$
  as a morphism of $G\mathrm{Corel}$. This is a bijection. 
  
  To check it is composition and monoidal product preserving, we can easily use
  diagrammatic reasoning. For example

  Therefore $\mc H$ is isomorphic
  as a hypergraph category to $G\mathrm{Corel}$. 
\end{proof}

\begin{theorem}
  All hypergraph functors are decorated corelation functors.
\end{theorem}
\begin{proof}
  Let $\mc H$ and $\mc H'$ be hypergraph categories, and $T\maps \mc H \to \mc
  H'$ be a hypergraph functor. By the above theorem, there exist symmetric lax
  monoidal functors 
  \[
    G\maps \cospan(\FinSet_{\mc O_{\mc H}}) \to \Set 
  \]
  and 
  \[
    G'\maps \cospan(\FinSet_{\mc O_{\mc H'}}) \to \Set 
  \]
  such that $\mc H = G\mathrm{Corel}$ and $\mc H' = G'\mathrm{Corel}$.
  Furthermore, define a functor $A\maps \FinSet_{\mc O_{\mc H}} \to \FinSet_{\mc
    O_{\mc H'}}$ taking $N \to \mc O_{\mc H}$ to $N \to \mc O_{\mc H} \to \mc
  O_{\mc H'}$, where the second map is that by the functor $T$ on objects of
  $\mc H$. We claim this is a well-defined colimit-preserving functor and show
  that $T$ can be constructed from a monoidal natural transformation between $G$
  and $G'\circ A$.
\end{proof}

Compare with Spivak Vagner construction.

\subsection{Examples.}
We give some examples reproducing hypergraph categories as decorated corelations
categories.

\begin{example}
  Example: empty decorations and equivalence relations. 
  
  Consider the hypergraph category $\cospan(\FinSet)$. This is the simplest
  hypergraph category: it is free hypergraph category on the one object discrete
  category. We show how to recover it as a decorated corelation category.

  As per Example \ref{ex.undeccorel}, $\cospan(\FinSet)$ is the hypergraph
  category of undecorated (morphism-isomorphism)-corelations in $\FinSet$. It is
  also the partition-decorated (isomorphism-morphism)-corelations in $\FinSet$.   
  
  First, the global sections functor $G\maps \cospan(\FinSet) \to \Set$ takes
  each finite set $X$ to the set of (equivalence classes of) cospans $0 \to D
  \leftarrow X$; that is, to the set of functions $X \to D$ where a unique $D$
  is chosen for each finite cardinality. Given a cospan $X \stackrel{f}\to N
  \stackrel{g}\leftarrow Y$, its image under the global sections functor maps a
  function $a\maps X \to D$, to the function $Y \to N+_YD$ given by
  \[
    \xymatrix{
      & X \ar[r]^d \ar[d]_f & D \ar[d] \\
      Y \ar[r]^g  & N \ar[r] & N+_YD
    }
  \]
  where the square is a pushout square.

  The coherence maps $\gamma_1\maps 1 \to G\varnothing$ map the unique element
  of $1$ to the unique function $!\maps \varnothing \to \varnothing$, and
  $\gamma_{X,Y}$ maps a pair of functions $a\maps X \to D$, $b\maps Y \to E$ to
  $a+b\maps X+Y \to D+E$. This is a symmetric lax monoidal functor. We use this
  functor to decorate cospans in $\FinSet$. 

  A decorated cospan in $\FinSet$ with respect to this functor is a cospan $X
  \to N \leftarrow Y$ in $\FinSet$ together with a function $N \to D$ for some
  finite set. Using the isomorphism--morphism factorisation, a decorated
  corelation (a morphism in $G\mathrm{Corel}$) is a
  cospan $X \to X+Y \leftarrow Y$, together with a function $X+Y \to D$.
  This is the same as a cospan. 

  The hypergraph structure is given by the decoration $X+X \to X$ etc, as the
  shift from cospans to corelations takes the `factored out part' and puts it
  into the decoration. At this point the morphisms are specified entirely by
  their decoration.

  It is straightforward to show the two categories are isomorphic. Note that the
  identity on $\FinSet$ maps $\mc I_\FinSet$ into $\FinSet$, and so extends to
  morphism $\FinSet \to \cospan(\FinSet)$. We can define a monoidal natural
  transformation $1(X) =1 \stackrel{\theta_X}\to GX = \{X \to D\}$ mapping the
  unique element to the identity function $1_X\maps X \to X$.
  \[
    \xymatrixrowsep{2ex}
    \xymatrix{
      \FinSet = \FinSet; \mc I_{\FinSet}^\opp \ar[dd]_{\iota} \ar[drr]^1  \\
      &\twocell \omit{_\:\theta}& \Set \\
      \cospan(\FinSet) = \FinSet; \FinSet^\opp \ar[urr]_{G} 
    }
  \]
  It is easy to verify that this is a monoidal natural transformation. This
  gives the hypergraph functor we expect, mapping the undecorated cospan $X \to
  N \leftarrow Y$ to $X \to X+Y \leftarrow Y$ decorated by $X+Y \to N$. 

  Like so many examples before, it is easy to verify this is a full, faithful,
  bijective-on-objects hypergraph functor.
\end{example}

\begin{example}
  The previous example extends to any finitely cocomplete category $\mc C$: the
  hypergraph category $\cospan(\mc C)$ can always be constructed as (i)
  trivially decorated $(\mc C, \mc I_{\mc C})$-corelations, or (ii) $(\mc I_{\mc
  C}, \mc C)$-corelations decorated by equivalence classes of morphisms with
  domain the apex of the corelation, and moreover the isomorphism of these
  hypergraph categories is given by a monoidal natural transformation between
  the decorating functors.

  More general still, a category of trivially decorated $(\mc E, \mc
  M)$-corelations in $\mc C$ can always be constructed also as $(\mc I_{\mc C},
  \mc C)$-corelations decorated by equivalence classes of morphisms in $\mc E$
  with domain the apex of the corelation, and the isomorphism of these
  hypergraph categories is given by a monoidal natural transformation between
  the decorating functors.

  Most general, the theorem implies that any category of decorated
  corelations can be constructed also as $(\mc I_{\mc C}, \mc C)$-corelations
  decorated by codomain decorated morphisms in $\mc E$. The latter are specified
  by a functor $\cospan(\mc C) \to \Set$, as in the theorem.

  The latter form is good for constructing functors that have image the
  corelation category.
\end{example}

Note that with decorated corelations we have a method of constructing hypergraph
categories from other hypergraph categories. This is black boxing. 

\section{Examples} \label{sec:excor}
\subsection{Path integrals and matrices}

Let $R$ be a commutative ring. Take functor
\begin{align*}
  R^{(-)}: (\mathrm{FinSet}^\opp,+) &\longrightarrow (\Set,\times) \\
  X &\longmapsto R^X
\end{align*}

Then $R^{(-)}\mathrm{Cospan}$ is path integrals, $R^{(-)}\mathrm{Corel}$ is
matrices over $R$. 

Many aspects of this example are `atypical', regarding the intuition we have
been working towards.
Note that the monoidal product here is the tensor product of
matrices, not the biproduct. Indeed, there is no special commutative Frobenius
algebra in $\Vect$ if we use the biproduct, but if we use the tensor product
then these correspond to orthonormal bases (Vicary). The comultiplication is the
diagonal map, multiplication is codiagonal. unit produces basis.

We note that you could take decorations here in the category $R\mathrm{Mod}$ of
$R$-modules. While Proposition \ref{prop.setdecorations} shows that the
resulting decorated cospans category would be isomorphic, this hints at an
enriched version of the theory.

\subsection{Two constructions for linear relations}

We saw earlier that linear relations are epi-mono corelations in $\Vect$. The
hypergraph structure is given by addition. We show how to recover this in
another construction. We also get a hypergraph functor between them. This is
very useful for compositional linear relations semantics of diagrams.

We can also construct linear relations in $\Vect^\opp$.

\begin{align*}
  \maps\mathrm{Cospan}(\mathrm{FinSet}) &\longrightarrow \mathrm{Set} \\
  X &\longmapsto \{\mathrm{subspaces of }k^X\} \\
  f: X \to Y &\longmapsto L \mapsto \{v \mid v\circ f \in L\} \\
  f^\opp: X \to Y &\longmapsto L \mapsto \{v = u \circ f \mid u \in L\}
\end{align*}

Then $\mathrm{Cospan}$ is cospans decorated by subspaces, and $\mathrm{Corel}$
is linear relations. This is important for circuits work \cite{BF,BSZ}.

\subsection{Automata}
This construction comes immediately from Walters et al. Automata are alphabet
labelled graphs. There is a decorated cospan functor to categories enriched over
languages, and this factors nicely to get a decorated corelation category with
morphisms languages recognised between points in domain and codomain.







%  Our proof will have an inductive flavour. We first assume $\corel_(\mc C)$ is
%  well-defined as a hypergraph category, and show  We caution that we still have not proved that $\corel(\mc C)$ is a category,
%  let alone a hypergraph category. Thus to begin, all we can show is that the map
%  $\square$ is composition-preserving, and then that $\square$ respects the
%  monoidal and hypergraph structure. But this is enough to prove both
%  results! Indeed, specialising to the case where $A$ is the identity functor on
%  $\mc C$ and $(\mc E,\mc M)=(\mc C, \mc I_{\mc C})$, observe   
%  \[
%    \square \maps \cospan(\mc C) \longrightarrow \corel(\mc C)
%  \]
%  is then the map taking each cospan to its jointly $\mc E$-like part. Note
%  $\square$ maps fully (surjectively-on-morphisms) and bijectively-on-objects
%  onto $\corel(\mc C)$, and by definition the coherence and hypergraph maps on
%  $\corel(\mc C)$ are precisely the image of the corresponding maps of
%  $\cospan(\mc C)$. As $\cospan(\mc C)$ is a hypergraph category and $\square$
%  is composition-preserving, we can consequently conclude that all corelation
%  categories are indeed hypergraph categories, and hence that $\square$---in the
%  general case---is a hypergraph functor.
%
%  Finally, specialising to the case where $A$
%  is the identity functor on $\mc C$ and $(\mc E,\mc M)$ is the factorisation
%  system $(\mc C, \mc I_{\mc C})$, we observe that the domain of $\square$ is
%  then $\cospan(\mc C)$, and that $\square$ maps it fully
%  (surjectively-on-morphisms) and bijectively-on-objects onto $\corel(\mc C')$.
%  This shows that all corelation categories are indeed deserving of the name
%  category and moreover hypergraph category, and hence that $\square$ is
%  deserving of the name hypergraph functor.
